<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="CodeGraph documentation: RBAC и Авторизация">
  <meta name="keywords" content="CodeGraph, documentation, enterprise">

  <meta property="og:title" content="RBAC и Авторизация - CodeGraph">
  <meta property="og:description" content="CodeGraph documentation: RBAC и Авторизация">
  <meta property="og:type" content="article">

  <title>RBAC и Авторизация - CodeGraph Documentation</title>

  <link rel="icon" type="image/svg+xml" href="../../../assets/svg/logo-compact.svg">
  <link rel="stylesheet" href="../../../css/styles.css?v=2">
</head>
<body>
  <!-- Header -->
  <header class="header">
    <nav class="nav container">
      <a href="../../../" class="logo">
        <img src="../../../assets/svg/logo.svg" alt="CodeGraph" width="160" height="40">
      </a>

      <ul class="nav-list">
        <li><a href="../../../index.html#problems" class="nav-link">Проблемы</a></li>
        <li><a href="../../../index.html#solution" class="nav-link">Решение</a></li>
        <li><a href="../../../index.html#features" class="nav-link">Возможности</a></li>
        <li><a href="../../../index.html#integrations" class="nav-link">Интеграции</a></li>
        <li><a href="../index.html" class="nav-link active">Документация</a></li>
        <li><a href="../../../index.html#faq" class="nav-link">FAQ</a></li>
      </ul>

      <div class="header-actions">
        <div class="lang-switcher">
          <a href="../../en/enterprise/RBAC.html" class="">EN</a>
          <a href="../../ru/enterprise/RBAC.html" class="active">RU</a>
        </div>
        <button class="theme-toggle" aria-label="Переключить тему">
          <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
            <circle cx="12" cy="12" r="5"/>
            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
          </svg>
          <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
          </svg>
        </button>
        <a href="../../../index.html#demo" class="btn btn-primary">Запросить демо</a>
      </div>

      <button class="mobile-menu-toggle" aria-label="Menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </nav>
    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
      <ul class="mobile-nav-list">
        <li><a href="../../../index.html#problems" class="mobile-nav-link">Проблемы</a></li>
        <li><a href="../../../index.html#solution" class="mobile-nav-link">Решение</a></li>
        <li><a href="../../../index.html#features" class="mobile-nav-link">Возможности</a></li>
        <li><a href="../../../index.html#integrations" class="mobile-nav-link">Интеграции</a></li>
        <li><a href="../index.html" class="mobile-nav-link">Документация</a></li>
        <li><a href="../../../index.html#faq" class="mobile-nav-link">FAQ</a></li>
        <li><a href="../../../index.html#demo" class="btn btn-primary mobile-nav-demo-btn">Запросить демо</a></li>
      </ul>
    </nav>
  </header>

  <div class="doc-layout">
    <!-- Sidebar Navigation -->
    <aside class="doc-sidebar">
      
    <div class="doc-sidebar-section">
      <div class="doc-sidebar-title">Начало работы</div>
      <ul class="doc-sidebar-nav">
        <li><a href="../getting-started/index.html">Обзор</a></li>
        <li><a href="../getting-started/CONFIGURATION.html">Руководство по настройке</a></li>
        <li><a href="../getting-started/INSTALLATION.html">Руководство по установке</a></li>
      </ul>
    </div>

    <div class="doc-sidebar-section">
      <div class="doc-sidebar-title">Руководства</div>
      <ul class="doc-sidebar-nav">
        <li><a href="../guides/index.html">Обзор</a></li>
        <li><a href="../guides/BENCHMARK_GUIDE.html">Руководство по тестовой платформе</a></li>
        <li><a href="../guides/CLI_GUIDE.html">Руководство по CLI</a></li>
        <li><a href="../guides/CODE_REVIEW.html">Автоматический код-ревью</a></li>
        <li><a href="../guides/CPG_EXPORT.html">Руководство по экспорту CPG</a></li>
        <li><a href="../guides/MONITORING.html">Руководство по мониторингу</a></li>
        <li><a href="../guides/PROGRAMMATIC_GUIDE.html">Руководство пользователя</a></li>
        <li><a href="../guides/PROJECT_IMPORT.html">Импорт новой кодовой базы</a></li>
        <li><a href="../guides/QUICK_REFERENCE.html">Краткое руководство по CodeGraph</a></li>
        <li><a href="../guides/REFACTORING.html">Руководство по анализу рефакторинга</a></li>
        <li><a href="../guides/SCENARIOS.html">Руководство по сценариям рабочих процессов</a></li>
        <li><a href="../guides/TROUBLESHOOTING.html">Руководство по устранению неполадок</a></li>
        <li><a href="../guides/TUI_USER_GUIDE.html">Руководство пользователя CodeGraph</a></li>
        <li><a href="../guides/01-onboarding.html">Сценарий 01: Ввод нового разработчика</a></li>
        <li><a href="../guides/02-security-audit.html">Сценарий 02: Аудит безопасности</a></li>
        <li><a href="../guides/03-documentation.html">Сценарий 03: Генерация документации</a></li>
        <li><a href="../guides/04-feature-development.html">Сценарий 04: Разработка функций</a></li>
        <li><a href="../guides/05-refactoring.html">Сценарий 05: Рефакторинг</a></li>
        <li><a href="../guides/06-performance.html">Сценарий 06: Анализ производительности</a></li>
        <li><a href="../guides/07-test-coverage.html">Сценарий 07: Покрытие тестами</a></li>
        <li><a href="../guides/08-compliance.html">Сценарий 08: Проверка соответствия требованиям</a></li>
        <li><a href="../guides/09-code-review.html">Сценарий 09: Код-ревью</a></li>
        <li><a href="../guides/10-cross-repo.html">Сценарий 10: Анализ между репозиториями</a></li>
        <li><a href="../guides/11-architecture.html">Сценарий 11: Анализ архитектуры</a></li>
        <li><a href="../guides/12-tech-debt.html">Сценарий 12: Оценка технического долга</a></li>
        <li><a href="../guides/13-mass-refactoring.html">Сценарий 13: Массовая рефакторизация</a></li>
        <li><a href="../guides/14-incident-response.html">Сценарий 14: Реагирование на инциденты безопасности</a></li>
        <li><a href="../guides/15-debugging.html">Сценарий 15: Помощь в отладке</a></li>
        <li><a href="../guides/16-entry-points.html">Сценарий 16: Обнаружение точки входа</a></li>
      </ul>
    </div>

    <div class="doc-sidebar-section">
      <div class="doc-sidebar-title">API Документация</div>
      <ul class="doc-sidebar-nav">
        <li><a href="../api/index.html">Обзор</a></li>
        <li><a href="../api/ACP_INTEGRATION.html">Интеграция Agent Client Protocol (ACP)</a></li>
        <li><a href="../api/REST_API.html">Документация по REST API CodeGraph</a></li>
        <li><a href="../api/WEBSOCKET_API.html">Справочная документация по WebSocket API</a></li>
      </ul>
    </div>

    <div class="doc-sidebar-section">
      <div class="doc-sidebar-title">Интеграции</div>
      <ul class="doc-sidebar-nav">
        <li><a href="../integrations/index.html">Обзор</a></li>
        <li><a href="../integrations/GIGACHAT.html">Руководство по интеграции GigaChat</a></li>
        <li><a href="../integrations/YANDEX_AI_STUDIO.html">Руководство по интеграции Yandex AI Studio</a></li>
      </ul>
    </div>

    <div class="doc-sidebar-section">
      <div class="doc-sidebar-title">Справочник</div>
      <ul class="doc-sidebar-nav">
        <li><a href="../reference/index.html">Обзор</a></li>
        <li><a href="../reference/AGENTS.html">Справочник агентов</a></li>
        <li><a href="../reference/ANALYSIS_MODULES.html">Справочник модулей анализа</a></li>
        <li><a href="../reference/API.html">Справочник API</a></li>
        <li><a href="../reference/HYPOTHESIS_SYSTEM.html">Справочная система гипотез</a></li>
        <li><a href="../reference/SCHEMA.html">Дизайн схемы DuckDB CPG (CPG Spec v1.1)</a></li>
        <li><a href="../reference/SECURITY.html">Модуль корпоративной безопасности</a></li>
        <li><a href="../reference/SQL_QUERY_COOKBOOK.html">Кулинарная книга SQL-запросов для DuckDB CPG</a></li>
        <li><a href="../reference/WORKFLOWS.html">Справочник по рабочим процессам</a></li>
      </ul>
    </div>

    <div class="doc-sidebar-section">
      <div class="doc-sidebar-title">Enterprise</div>
      <ul class="doc-sidebar-nav">
        <li><a href="index.html">Обзор</a></li>
        <li><a href="COMPETITIVE_MATRIX.html">Конкурентная матрица CodeGraph</a></li>
        <li><a href="DEPLOYMENT_GUIDE.html">Корпоративное развёртывание</a></li>
        <li><a href="DLP_SECURITY.html">DLP: Предотвращение утечки данных</a></li>
        <li><a href="HYPOTHESIS_WHITEPAPER.html">Валидация гипотез безопасности</a></li>
        <li><a href="LLM_SECURITY.html">Безопасность LLM-интеграции</a></li>
        <li><a href="RBAC.html" class="active">RBAC и Авторизация</a></li>
        <li><a href="SECURITY_BRIEF.html">Корпоративная безопасность</a></li>
        <li><a href="SIEM.html">Интеграция с SIEM</a></li>
      </ul>
    </div>
    </aside>

    <!-- Main Content -->
    <main class="doc-main">
      <!-- Breadcrumb -->
      <nav class="doc-breadcrumb">
        <a href="../index.html">Документация</a>
        <span>/</span>
        <a href="index.html">Enterprise</a>
        <span>/</span>
        <span>RBAC и Авторизация</span>
      </nav>

      <!-- Hero -->
      <div class="doc-hero">
        <h1>RBAC и Авторизация</h1>
        
      </div>

      <!-- Content -->
      <article class="doc-content">
        <h1 id="rbac-i-avtorizatsiya">RBAC и Авторизация<a class="heading-anchor" href="#rbac-i-avtorizatsiya" title="Link to this section">&para;</a></h1>
<blockquote class="callout">
<p>Техническая документация для команд ИТ и информационной безопасности</p>
</blockquote>
<hr />
<h2 id="soderzhanie">Содержание<a class="heading-anchor" href="#soderzhanie" title="Link to this section">&para;</a></h2>
<ul>
<li><a href="#obzor">Обзор</a></li>
<li><a href="#klyuchevye-vozmozhnosti">Ключевые возможности</a></li>
<li><a href="#arhitektura-rbac">Архитектура RBAC</a></li>
<li><a href="#ierarhiya-roley">Иерархия ролей</a></li>
<li><a href="#nasledovanie-razresheniy">Наследование разрешений</a></li>
<li><a href="#katalog-razresheniy">Каталог разрешений</a></li>
<li><a href="#razresheniya-po-kategoriyam">Разрешения по категориям</a></li>
<li><a href="#metody-autentifikatsii">Методы аутентификации</a></li>
<li><a href="#1-jwt-bearer-token">1. JWT Bearer Token</a></li>
<li><a href="#2-api-klyuchi">2. API-ключи</a></li>
<li><a href="#3-oauth2oidc-gotovo-k-integratsii">3. OAuth2/OIDC (готово к интеграции)</a></li>
<li><a href="#4-ldapactive-directory-gotovo-k-integratsii">4. LDAP/Active Directory (готово к интеграции)</a></li>
<li><a href="#api-reference">API Reference</a></li>
<li><a href="#middleware-zavisimosti">Middleware зависимости</a></li>
<li><a href="#primery-ispolzovaniya-v-fastapi">Примеры использования в FastAPI</a></li>
<li><a href="#authcontext">AuthContext</a></li>
<li><a href="#audit-i-logirovanie">Аудит и логирование</a></li>
<li><a href="#sobytiya-avtorizatsii">События авторизации</a></li>
<li><a href="#format-loga">Формат лога</a></li>
<li><a href="#luchshie-praktiki">Лучшие практики</a></li>
<li><a href="#dlya-administratorov">Для администраторов</a></li>
<li><a href="#dlya-razrabotchikov">Для разработчиков</a></li>
<li><a href="#svyazannye-dokumenty">Связанные документы</a></li>
</ul>
<h2 id="obzor">Обзор<a class="heading-anchor" href="#obzor" title="Link to this section">&para;</a></h2>
<p>CodeGraph реализует комплексную систему контроля доступа на основе ролей (RBAC) с поддержкой множества методов аутентификации. Система обеспечивает гранулярный контроль доступа к функциям платформы.</p>
<h3 id="klyuchevye-vozmozhnosti">Ключевые возможности<a class="heading-anchor" href="#klyuchevye-vozmozhnosti" title="Link to this section">&para;</a></h3>
<ul>
<li><strong>4 уровня ролей</strong> с иерархическим наследованием</li>
<li><strong>21 гранулярное разрешение</strong> по категориям функциональности</li>
<li><strong>Множество методов аутентификации</strong>: JWT, API-ключи, OAuth2, LDAP</li>
<li><strong>Blacklisting токенов</strong> для мгновенного отзыва доступа</li>
<li><strong>Интеграция с SIEM</strong> для аудита событий авторизации</li>
</ul>
<hr />
<h2 id="arhitektura-rbac">Архитектура RBAC<a class="heading-anchor" href="#arhitektura-rbac" title="Link to this section">&para;</a></h2>
<h3 id="ierarhiya-roley">Иерархия ролей<a class="heading-anchor" href="#ierarhiya-roley" title="Link to this section">&para;</a></h3>
<div class="highlight"><pre><span></span><code>                           ┌─────────────────────┐
                           │       ADMIN         │
                           │    (admin:all)      │
                           │   Полный доступ     │
                           └──────────┬──────────┘
                                      │
                           ┌──────────▼──────────┐
                           │      REVIEWER       │
                           │  Код-ревью + GitHub │
                           │      + GitLab       │
                           └──────────┬──────────┘
                                      │
                           ┌──────────▼──────────┐
                           │      ANALYST        │
                           │  Выполнение запросов│
                           │  + API-ключи        │
                           └──────────┬──────────┘
                                      │
                           ┌──────────▼──────────┐
                           │       VIEWER        │
                           │  Только чтение      │
                           └─────────────────────┘
</code></pre></div>

<h3 id="nasledovanie-razresheniy">Наследование разрешений<a class="heading-anchor" href="#nasledovanie-razresheniy" title="Link to this section">&para;</a></h3>
<p>Каждая роль наследует все разрешения нижестоящих ролей:
- <code>ADMIN</code> → все разрешения (<code>admin:all</code>)
- <code>REVIEWER</code> → разрешения <code>ANALYST</code> + код-ревью
- <code>ANALYST</code> → разрешения <code>VIEWER</code> + выполнение/экспорт
- <code>VIEWER</code> → только чтение (базовый уровень)</p>
<hr />
<h2 id="katalog-razresheniy">Каталог разрешений<a class="heading-anchor" href="#katalog-razresheniy" title="Link to this section">&para;</a></h2>
<h3 id="razresheniya-po-kategoriyam">Разрешения по категориям<a class="heading-anchor" href="#razresheniya-po-kategoriyam" title="Link to this section">&para;</a></h3>
<h4 id="stsenarii-scenarios">Сценарии (<code>scenarios:*</code>)<a class="heading-anchor" href="#stsenarii-scenarios" title="Link to this section">&para;</a></h4>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Разрешение</th>
<th>Описание</th>
<th style="text-align: center;">VIEWER</th>
<th style="text-align: center;">ANALYST</th>
<th style="text-align: center;">REVIEWER</th>
<th style="text-align: center;">ADMIN</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>scenarios:read</code></td>
<td>Просмотр списка сценариев</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
</tr>
<tr>
<td><code>scenarios:execute</code></td>
<td>Запуск сценариев анализа</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
</tr>
</tbody>
</table></div>
<h4 id="zaprosy-query">Запросы (<code>query:*</code>)<a class="heading-anchor" href="#zaprosy-query" title="Link to this section">&para;</a></h4>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Разрешение</th>
<th>Описание</th>
<th style="text-align: center;">VIEWER</th>
<th style="text-align: center;">ANALYST</th>
<th style="text-align: center;">REVIEWER</th>
<th style="text-align: center;">ADMIN</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>query:execute</code></td>
<td>Выполнение SQL-запросов к CPG</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
</tr>
<tr>
<td><code>query:validate</code></td>
<td>Валидация синтаксиса запросов</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
</tr>
</tbody>
</table></div>
<h4 id="kod-revyu-review">Код-ревью (<code>review:*</code>)<a class="heading-anchor" href="#kod-revyu-review" title="Link to this section">&para;</a></h4>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Разрешение</th>
<th>Описание</th>
<th style="text-align: center;">VIEWER</th>
<th style="text-align: center;">ANALYST</th>
<th style="text-align: center;">REVIEWER</th>
<th style="text-align: center;">ADMIN</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>review:execute</code></td>
<td>Запуск автоматического ревью</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
</tr>
<tr>
<td><code>review:github</code></td>
<td>Интеграция с GitHub PR</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
</tr>
<tr>
<td><code>review:gitlab</code></td>
<td>Интеграция с GitLab MR</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
</tr>
</tbody>
</table></div>
<h4 id="sessii-sessions">Сессии (<code>sessions:*</code>)<a class="heading-anchor" href="#sessii-sessions" title="Link to this section">&para;</a></h4>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Разрешение</th>
<th>Описание</th>
<th style="text-align: center;">VIEWER</th>
<th style="text-align: center;">ANALYST</th>
<th style="text-align: center;">REVIEWER</th>
<th style="text-align: center;">ADMIN</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>sessions:read</code></td>
<td>Просмотр сессий</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
</tr>
<tr>
<td><code>sessions:write</code></td>
<td>Создание/изменение сессий</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
</tr>
<tr>
<td><code>sessions:delete</code></td>
<td>Удаление сессий</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
</tr>
</tbody>
</table></div>
<h4 id="istoriya-history">История (<code>history:*</code>)<a class="heading-anchor" href="#istoriya-history" title="Link to this section">&para;</a></h4>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Разрешение</th>
<th>Описание</th>
<th style="text-align: center;">VIEWER</th>
<th style="text-align: center;">ANALYST</th>
<th style="text-align: center;">REVIEWER</th>
<th style="text-align: center;">ADMIN</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>history:read</code></td>
<td>Просмотр истории запросов</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
</tr>
<tr>
<td><code>history:export</code></td>
<td>Экспорт истории</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
</tr>
</tbody>
</table></div>
<h4 id="polzovateli-users">Пользователи (<code>users:*</code>)<a class="heading-anchor" href="#polzovateli-users" title="Link to this section">&para;</a></h4>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Разрешение</th>
<th>Описание</th>
<th style="text-align: center;">VIEWER</th>
<th style="text-align: center;">ANALYST</th>
<th style="text-align: center;">REVIEWER</th>
<th style="text-align: center;">ADMIN</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>users:read</code></td>
<td>Просмотр списка пользователей</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
</tr>
<tr>
<td><code>users:write</code></td>
<td>Создание/редактирование</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
</tr>
<tr>
<td><code>users:delete</code></td>
<td>Удаление пользователей</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
</tr>
</tbody>
</table></div>
<h4 id="api-klyuchi-api-keys">API-ключи (<code>api_keys:*</code>)<a class="heading-anchor" href="#api-klyuchi-api-keys" title="Link to this section">&para;</a></h4>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Разрешение</th>
<th>Описание</th>
<th style="text-align: center;">VIEWER</th>
<th style="text-align: center;">ANALYST</th>
<th style="text-align: center;">REVIEWER</th>
<th style="text-align: center;">ADMIN</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>api_keys:read</code></td>
<td>Просмотр своих ключей</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
</tr>
<tr>
<td><code>api_keys:write</code></td>
<td>Создание ключей</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
</tr>
<tr>
<td><code>api_keys:delete</code></td>
<td>Удаление любых ключей</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
</tr>
</tbody>
</table></div>
<h4 id="metriki-stats-metrics">Метрики (<code>stats:*</code>, <code>metrics:*</code>)<a class="heading-anchor" href="#metriki-stats-metrics" title="Link to this section">&para;</a></h4>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Разрешение</th>
<th>Описание</th>
<th style="text-align: center;">VIEWER</th>
<th style="text-align: center;">ANALYST</th>
<th style="text-align: center;">REVIEWER</th>
<th style="text-align: center;">ADMIN</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>stats:read</code></td>
<td>Просмотр статистики</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
<td style="text-align: center;">✓</td>
</tr>
<tr>
<td><code>metrics:read</code></td>
<td>Prometheus метрики</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
</tr>
</tbody>
</table></div>
<h4 id="administrirovanie">Администрирование<a class="heading-anchor" href="#administrirovanie" title="Link to this section">&para;</a></h4>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Разрешение</th>
<th>Описание</th>
<th style="text-align: center;">VIEWER</th>
<th style="text-align: center;">ANALYST</th>
<th style="text-align: center;">REVIEWER</th>
<th style="text-align: center;">ADMIN</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>admin:all</code></td>
<td>Полный доступ</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">✓</td>
</tr>
</tbody>
</table></div>
<hr />
<h2 id="metody-autentifikatsii">Методы аутентификации<a class="heading-anchor" href="#metody-autentifikatsii" title="Link to this section">&para;</a></h2>
<h3 id="1-jwt-bearer-token">1. JWT Bearer Token<a class="heading-anchor" href="#1-jwt-bearer-token" title="Link to this section">&para;</a></h3>
<p>Основной метод для веб-приложений и интерактивных сессий.</p>
<h4 id="struktura-tokena">Структура токена<a class="heading-anchor" href="#struktura-tokena" title="Link to this section">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TokenPayload</span><span class="p">:</span>
    <span class="n">sub</span><span class="p">:</span> <span class="nb">str</span>       <span class="c1"># User ID</span>
    <span class="n">jti</span><span class="p">:</span> <span class="nb">str</span>       <span class="c1"># JWT ID (уникальный идентификатор)</span>
    <span class="n">exp</span><span class="p">:</span> <span class="n">datetime</span>  <span class="c1"># Время истечения</span>
    <span class="n">iat</span><span class="p">:</span> <span class="n">datetime</span>  <span class="c1"># Время выдачи</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span>      <span class="c1"># &quot;access&quot; или &quot;refresh&quot;</span>
    <span class="n">scopes</span><span class="p">:</span> <span class="nb">list</span>   <span class="c1"># Список разрешений</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>      <span class="c1"># Роль пользователя</span>
</code></pre></div>

<h4 id="parametry-tokenov">Параметры токенов<a class="heading-anchor" href="#parametry-tokenov" title="Link to this section">&para;</a></h4>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Тип токена</th>
<th>TTL</th>
<th>Назначение</th>
</tr>
</thead>
<tbody>
<tr>
<td>Access Token</td>
<td>30 минут</td>
<td>Авторизация API-запросов</td>
</tr>
<tr>
<td>Refresh Token</td>
<td>7 дней</td>
<td>Обновление access-токена</td>
</tr>
</tbody>
</table></div>
<h4 id="primer-ispolzovaniya">Пример использования<a class="heading-anchor" href="#primer-ispolzovaniya" title="Link to this section">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Получение токена</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>/api/v1/auth/login<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{&quot;username&quot;: &quot;analyst&quot;, &quot;password&quot;: &quot;***&quot;}&#39;</span>

<span class="c1"># Response:</span>
<span class="o">{</span>
<span class="w">  </span><span class="s2">&quot;access_token&quot;</span>:<span class="w"> </span><span class="s2">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...&quot;</span>,
<span class="w">  </span><span class="s2">&quot;refresh_token&quot;</span>:<span class="w"> </span><span class="s2">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...&quot;</span>,
<span class="w">  </span><span class="s2">&quot;token_type&quot;</span>:<span class="w"> </span><span class="s2">&quot;bearer&quot;</span>,
<span class="w">  </span><span class="s2">&quot;expires_in&quot;</span>:<span class="w"> </span><span class="m">1800</span>
<span class="o">}</span>

<span class="c1"># Использование токена</span>
curl<span class="w"> </span>-X<span class="w"> </span>GET<span class="w"> </span>/api/v1/scenarios<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...&quot;</span>
</code></pre></div>

<h4 id="otzyv-tokena-blacklisting">Отзыв токена (Blacklisting)<a class="heading-anchor" href="#otzyv-tokena-blacklisting" title="Link to this section">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Logout - добавление токена в blacklist</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>/api/v1/auth/logout<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...&quot;</span>
</code></pre></div>

<p>После добавления в blacklist токен мгновенно становится недействительным.</p>
<hr />
<h3 id="2-api-klyuchi">2. API-ключи<a class="heading-anchor" href="#2-api-klyuchi" title="Link to this section">&para;</a></h3>
<p>Для интеграций, CI/CD и автоматизации.</p>
<h4 id="format-api-klyucha">Формат API-ключа<a class="heading-anchor" href="#format-api-klyucha" title="Link to this section">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">Prefix</span><span class="o">:</span><span class="w"> </span><span class="n">cgk_</span><span class="w">          </span><span class="o">(</span><span class="n">CodeGraph</span><span class="w"> </span><span class="n">Key</span><span class="o">)</span>
<span class="n">Secret</span><span class="o">:</span><span class="w"> </span><span class="o">[</span><span class="mi">36</span><span class="w"> </span><span class="err">символов</span><span class="o">]</span><span class="w"> </span><span class="o">(</span><span class="n">UUID</span><span class="w"> </span><span class="n">v4</span><span class="o">)</span>

<span class="err">Пример</span><span class="o">:</span><span class="w"> </span><span class="n">cgk_550e8400</span><span class="o">-</span><span class="n">e29b</span><span class="o">-</span><span class="mi">41</span><span class="n">d4</span><span class="o">-</span><span class="n">a716</span><span class="o">-</span><span class="mi">446655440000</span>
</code></pre></div>

<h4 id="bezopasnost-hraneniya">Безопасность хранения<a class="heading-anchor" href="#bezopasnost-hraneniya" title="Link to this section">&para;</a></h4>
<ul>
<li>Ключи хешируются SHA-256 перед сохранением</li>
<li>Полный ключ показывается только при создании</li>
<li>Поддержка срока действия и отзыва</li>
</ul>
<h4 id="primer-ispolzovaniya_1">Пример использования<a class="heading-anchor" href="#primer-ispolzovaniya_1" title="Link to this section">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Создание API-ключа</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>/api/v1/auth/api-keys<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Authorization: Bearer &lt;admin_token&gt;&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{&quot;name&quot;: &quot;CI Pipeline&quot;, &quot;scopes&quot;: [&quot;query:execute&quot;, &quot;scenarios:execute&quot;]}&#39;</span>

<span class="c1"># Response:</span>
<span class="o">{</span>
<span class="w">  </span><span class="s2">&quot;id&quot;</span>:<span class="w"> </span><span class="s2">&quot;key_123&quot;</span>,
<span class="w">  </span><span class="s2">&quot;key&quot;</span>:<span class="w"> </span><span class="s2">&quot;cgk_550e8400-e29b-41d4-a716-446655440000&quot;</span>,<span class="w">  </span><span class="c1"># Показывается только один раз!</span>
<span class="w">  </span><span class="s2">&quot;name&quot;</span>:<span class="w"> </span><span class="s2">&quot;CI Pipeline&quot;</span>,
<span class="w">  </span><span class="s2">&quot;scopes&quot;</span>:<span class="w"> </span><span class="o">[</span><span class="s2">&quot;query:execute&quot;</span>,<span class="w"> </span><span class="s2">&quot;scenarios:execute&quot;</span><span class="o">]</span>,
<span class="w">  </span><span class="s2">&quot;expires_at&quot;</span>:<span class="w"> </span><span class="s2">&quot;2026-01-01T00:00:00Z&quot;</span>
<span class="o">}</span>

<span class="c1"># Использование API-ключа</span>
curl<span class="w"> </span>-X<span class="w"> </span>GET<span class="w"> </span>/api/v1/scenarios<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;X-API-Key: cgk_550e8400-e29b-41d4-a716-446655440000&quot;</span>
</code></pre></div>

<h4 id="razresheniya-po-umolchaniyu-dlya-api-klyuchey">Разрешения по умолчанию для API-ключей<a class="heading-anchor" href="#razresheniya-po-umolchaniyu-dlya-api-klyuchey" title="Link to this section">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">default_scopes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;scenarios:read&quot;</span><span class="p">,</span>
    <span class="s2">&quot;scenarios:execute&quot;</span><span class="p">,</span>
    <span class="s2">&quot;query:execute&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sessions:read&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sessions:write&quot;</span><span class="p">,</span>
    <span class="s2">&quot;history:read&quot;</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div>

<hr />
<h3 id="3-oauth2oidc-gotovo-k-integratsii">3. OAuth2/OIDC (готово к интеграции)<a class="heading-anchor" href="#3-oauth2oidc-gotovo-k-integratsii" title="Link to this section">&para;</a></h3>
<p>Поддержка корпоративных провайдеров идентификации.</p>
<h4 id="podderzhivaemye-provaydery">Поддерживаемые провайдеры<a class="heading-anchor" href="#podderzhivaemye-provaydery" title="Link to this section">&para;</a></h4>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Провайдер</th>
<th>Статус</th>
<th>Сценарий</th>
</tr>
</thead>
<tbody>
<tr>
<td>GitHub</td>
<td>✅ Готово</td>
<td>Разработчики, open-source</td>
</tr>
<tr>
<td>GitLab</td>
<td>✅ Готово</td>
<td>Корпоративные GitLab</td>
</tr>
<tr>
<td>Google</td>
<td>✅ Готово</td>
<td>Google Workspace</td>
</tr>
<tr>
<td>Keycloak</td>
<td>✅ Готово</td>
<td>Enterprise IdP</td>
</tr>
<tr>
<td>Azure AD</td>
<td>✅ Готово</td>
<td>Microsoft 365</td>
</tr>
</tbody>
</table></div>
<h4 id="konfiguratsiya-primer-dlya-keycloak">Конфигурация (пример для Keycloak)<a class="heading-anchor" href="#konfiguratsiya-primer-dlya-keycloak" title="Link to this section">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">oauth2</span><span class="p">:</span>
<span class="w">  </span><span class="nt">providers</span><span class="p">:</span>
<span class="w">    </span><span class="nt">keycloak</span><span class="p">:</span>
<span class="w">      </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">      </span><span class="nt">client_id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;codegraph&quot;</span>
<span class="w">      </span><span class="nt">client_secret</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;${KEYCLOAK_SECRET}&quot;</span>
<span class="w">      </span><span class="nt">authorize_url</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://keycloak.company.com/realms/main/protocol/openid-connect/auth&quot;</span>
<span class="w">      </span><span class="nt">token_url</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://keycloak.company.com/realms/main/protocol/openid-connect/token&quot;</span>
<span class="w">      </span><span class="nt">userinfo_url</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://keycloak.company.com/realms/main/protocol/openid-connect/userinfo&quot;</span>
<span class="w">      </span><span class="nt">scopes</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;openid&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;profile&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;email&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;groups&quot;</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">role_claim</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;realm_access.roles&quot;</span>
<span class="w">      </span><span class="nt">role_mapping</span><span class="p">:</span>
<span class="w">        </span><span class="nt">codegraph-admin</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin</span>
<span class="w">        </span><span class="nt">codegraph-reviewer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviewer</span>
<span class="w">        </span><span class="nt">codegraph-analyst</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">analyst</span>
<span class="w">        </span><span class="nt">codegraph-viewer</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">viewer</span>
</code></pre></div>

<hr />
<h3 id="4-ldapactive-directory-gotovo-k-integratsii">4. LDAP/Active Directory (готово к интеграции)<a class="heading-anchor" href="#4-ldapactive-directory-gotovo-k-integratsii" title="Link to this section">&para;</a></h3>
<p>Интеграция с корпоративным каталогом.</p>
<h4 id="konfiguratsiya">Конфигурация<a class="heading-anchor" href="#konfiguratsiya" title="Link to this section">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="nt">ldap</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ldaps://ldap.company.com:636&quot;</span>
<span class="w">  </span><span class="nt">base_dn</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;dc=company,dc=com&quot;</span>
<span class="w">  </span><span class="nt">bind_dn</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;cn=codegraph,ou=services,dc=company,dc=com&quot;</span>
<span class="w">  </span><span class="nt">bind_password</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;${LDAP_PASSWORD}&quot;</span>
<span class="w">  </span><span class="nt">user_search_base</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ou=users,dc=company,dc=com&quot;</span>
<span class="w">  </span><span class="nt">user_search_filter</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;(sAMAccountName={username})&quot;</span>
<span class="w">  </span><span class="nt">group_search_base</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ou=groups,dc=company,dc=com&quot;</span>
<span class="w">  </span><span class="nt">group_membership_attr</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;memberOf&quot;</span>
<span class="w">  </span><span class="nt">group_mapping</span><span class="p">:</span>
<span class="w">    </span><span class="s">&quot;CN=CodeGraph-Admins,OU=Groups,DC=company,DC=com&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin</span>
<span class="w">    </span><span class="s">&quot;CN=CodeGraph-Reviewers,OU=Groups,DC=company,DC=com&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reviewer</span>
<span class="w">    </span><span class="s">&quot;CN=CodeGraph-Analysts,OU=Groups,DC=company,DC=com&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">analyst</span>
<span class="w">    </span><span class="s">&quot;CN=CodeGraph-Viewers,OU=Groups,DC=company,DC=com&quot;</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">viewer</span>
<span class="w">  </span><span class="nt">sync_interval_minutes</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15</span>
</code></pre></div>

<h4 id="sinhronizatsiya-grupp">Синхронизация групп<a class="heading-anchor" href="#sinhronizatsiya-grupp" title="Link to this section">&para;</a></h4>
<ul>
<li>Автоматическая синхронизация ролей с группами AD</li>
<li>Поддержка вложенных групп</li>
<li>Кэширование с настраиваемым TTL</li>
</ul>
<hr />
<h2 id="api-reference">API Reference<a class="heading-anchor" href="#api-reference" title="Link to this section">&para;</a></h2>
<h3 id="middleware-zavisimosti">Middleware зависимости<a class="heading-anchor" href="#middleware-zavisimosti" title="Link to this section">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">src.api.auth.middleware</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_auth_context</span><span class="p">,</span>     <span class="c1"># Получить контекст (без ошибки если не авторизован)</span>
    <span class="n">require_auth</span><span class="p">,</span>         <span class="c1"># Требовать любую аутентификацию</span>
    <span class="n">require_permission</span><span class="p">,</span>   <span class="c1"># Требовать конкретное разрешение</span>
    <span class="n">require_role</span><span class="p">,</span>         <span class="c1"># Требовать конкретную роль</span>
    <span class="n">require_admin</span><span class="p">,</span>        <span class="c1"># Shortcut для admin</span>
    <span class="n">require_analyst</span><span class="p">,</span>      <span class="c1"># Shortcut для analyst+</span>
    <span class="n">require_reviewer</span><span class="p">,</span>     <span class="c1"># Shortcut для reviewer+</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="primery-ispolzovaniya-v-fastapi">Примеры использования в FastAPI<a class="heading-anchor" href="#primery-ispolzovaniya-v-fastapi" title="Link to this section">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">APIRouter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.api.auth.middleware</span><span class="w"> </span><span class="kn">import</span> <span class="n">require_permission</span><span class="p">,</span> <span class="n">require_admin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.api.auth.permissions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Permission</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">()</span>

<span class="c1"># Требовать конкретное разрешение</span>
<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/query/execute&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute_query</span><span class="p">(</span>
    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">auth</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">require_permission</span><span class="p">(</span><span class="n">Permission</span><span class="o">.</span><span class="n">QUERY_EXECUTE</span><span class="p">))</span>
<span class="p">):</span>
    <span class="c1"># auth.user_id, auth.role, auth.scopes доступны</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span><span class="p">}</span>

<span class="c1"># Требовать одно из нескольких разрешений</span>
<span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/reviews&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_reviews</span><span class="p">(</span>
    <span class="n">auth</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">require_any_permission</span><span class="p">(</span>
        <span class="n">Permission</span><span class="o">.</span><span class="n">REVIEW_EXECUTE</span><span class="p">,</span>
        <span class="n">Permission</span><span class="o">.</span><span class="n">REVIEW_GITHUB</span><span class="p">,</span>
        <span class="n">Permission</span><span class="o">.</span><span class="n">REVIEW_GITLAB</span>
    <span class="p">))</span>
<span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;reviews&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">...</span><span class="p">]}</span>

<span class="c1"># Требовать роль Admin</span>
<span class="nd">@router</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;/users/</span><span class="si">{user_id}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete_user</span><span class="p">(</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">auth</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">require_admin</span><span class="p">)</span>
<span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;deleted&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">}</span>
</code></pre></div>

<h3 id="authcontext">AuthContext<a class="heading-anchor" href="#authcontext" title="Link to this section">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AuthContext</span><span class="p">:</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span>          <span class="c1"># ID пользователя</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span>         <span class="c1"># Имя пользователя</span>
    <span class="n">role</span><span class="p">:</span> <span class="n">Role</span>            <span class="c1"># Роль (VIEWER, ANALYST, REVIEWER, ADMIN)</span>
    <span class="n">scopes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>     <span class="c1"># Список разрешений</span>
    <span class="n">auth_method</span><span class="p">:</span> <span class="nb">str</span>      <span class="c1"># &quot;jwt&quot;, &quot;api_key&quot;, &quot;oauth2&quot;, &quot;ldap&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_authenticated</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Проверка аутентификации&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">permission</span><span class="p">:</span> <span class="n">Permission</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Проверка конкретного разрешения&quot;&quot;&quot;</span>
</code></pre></div>

<hr />
<h2 id="audit-i-logirovanie">Аудит и логирование<a class="heading-anchor" href="#audit-i-logirovanie" title="Link to this section">&para;</a></h2>
<h3 id="sobytiya-avtorizatsii">События авторизации<a class="heading-anchor" href="#sobytiya-avtorizatsii" title="Link to this section">&para;</a></h3>
<p>Все события авторизации логируются и отправляются в SIEM:</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Событие</th>
<th>Severity</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AUTH_SUCCESS</code></td>
<td>INFO</td>
<td>Успешная аутентификация</td>
</tr>
<tr>
<td><code>AUTH_FAILURE</code></td>
<td>WARNING</td>
<td>Неудачная попытка</td>
</tr>
<tr>
<td><code>TOKEN_ISSUED</code></td>
<td>INFO</td>
<td>Выдан новый токен</td>
</tr>
<tr>
<td><code>TOKEN_REVOKED</code></td>
<td>INFO</td>
<td>Токен отозван</td>
</tr>
<tr>
<td><code>PERMISSION_DENIED</code></td>
<td>WARNING</td>
<td>Отказ в доступе</td>
</tr>
<tr>
<td><code>API_KEY_CREATED</code></td>
<td>INFO</td>
<td>Создан API-ключ</td>
</tr>
<tr>
<td><code>API_KEY_REVOKED</code></td>
<td>INFO</td>
<td>API-ключ отозван</td>
</tr>
</tbody>
</table></div>
<h3 id="format-loga">Формат лога<a class="heading-anchor" href="#format-loga" title="Link to this section">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;timestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-12-14T10:30:00.000Z&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;event_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AUTH_SUCCESS&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;user_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user_123&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;username&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;analyst@company.com&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;role&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;analyst&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;auth_method&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jwt&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;ip_address&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;10.0.0.50&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;user_agent&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Mozilla/5.0...&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;request_path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/api/v1/scenarios&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;request_method&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;GET&quot;</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="luchshie-praktiki">Лучшие практики<a class="heading-anchor" href="#luchshie-praktiki" title="Link to this section">&para;</a></h2>
<h3 id="dlya-administratorov">Для администраторов<a class="heading-anchor" href="#dlya-administratorov" title="Link to this section">&para;</a></h3>
<ol>
<li><strong>Принцип наименьших привилегий</strong> — назначайте минимально необходимые роли</li>
<li><strong>Используйте API-ключи с ограниченными scopes</strong> для автоматизации</li>
<li><strong>Настройте синхронизацию с LDAP/AD</strong> для централизованного управления</li>
<li><strong>Включите SIEM-интеграцию</strong> для мониторинга событий безопасности</li>
<li><strong>Регулярно проводите аудит</strong> активных сессий и API-ключей</li>
</ol>
<h3 id="dlya-razrabotchikov">Для разработчиков<a class="heading-anchor" href="#dlya-razrabotchikov" title="Link to this section">&para;</a></h3>
<ol>
<li><strong>Используйте JWT для веб-приложений</strong>, API-ключи для CI/CD</li>
<li><strong>Храните refresh-токены безопасно</strong> (httpOnly cookies)</li>
<li><strong>Обрабатывайте 401/403</strong> корректно в UI</li>
<li><strong>Не логируйте токены и ключи</strong> в открытом виде</li>
</ol>
<hr />
<h2 id="svyazannye-dokumenty">Связанные документы<a class="heading-anchor" href="#svyazannye-dokumenty" title="Link to this section">&para;</a></h2>
<ul>
<li><a href="./SECURITY_BRIEF.html">Enterprise Security Brief</a> — Обзор безопасности</li>
<li><a href="./DLP_SECURITY.html">DLP Security</a> — Защита от утечки данных</li>
<li><a href="./SIEM.html">SIEM Integration</a> — Интеграция с SIEM</li>
<li><a href="../api/REST_API.html">REST API Reference</a> — Справочник API</li>
</ul>
<hr />
<p><em>Версия: 1.0 | Декабрь 2025</em></p>
      </article>

      <!-- Page Navigation -->
      <nav class="doc-page-nav">

      <a href="SECURITY_BRIEF.html" class="doc-page-nav-prev">
        <span class="doc-page-nav-label">Назад</span>
        <span class="doc-page-nav-title">Корпоративная безопасность</span>
      </a>

      <a href="DLP_SECURITY.html" class="doc-page-nav-next">
        <span class="doc-page-nav-label">Вперед</span>
        <span class="doc-page-nav-title">DLP: Предотвращение утечки данных</span>
      </a>
    </nav>

      <!-- Footer -->
      <footer class="doc-footer">
        <span>Обновлено: 2025-12-28</span>
        <a href="https://github.com/your-org/codegraph/edit/main/docs/enterprise/RBAC.md" target="_blank" rel="noopener">Редактировать на GitHub</a>
      </footer>
    </main>

    <!-- Table of Contents -->
    <aside class="doc-toc">
      <div class="doc-toc-title">На этой странице</div>
      <ul class="doc-toc-list">
        <li><a href="#rbac-i-avtorizatsiya" class="level-1">RBAC и Авторизация</a></li>
<li><a href="#soderzhanie" class="level-2">Содержание</a></li>
<li><a href="#obzor" class="level-2">Обзор</a></li>
<li><a href="#klyuchevye-vozmozhnosti" class="level-3">Ключевые возможности</a></li>
<li><a href="#arhitektura-rbac" class="level-2">Архитектура RBAC</a></li>
<li><a href="#ierarhiya-roley" class="level-3">Иерархия ролей</a></li>
<li><a href="#nasledovanie-razresheniy" class="level-3">Наследование разрешений</a></li>
<li><a href="#katalog-razresheniy" class="level-2">Каталог разрешений</a></li>
<li><a href="#razresheniya-po-kategoriyam" class="level-3">Разрешения по категориям</a></li>
<li><a href="#metody-autentifikatsii" class="level-2">Методы аутентификации</a></li>
<li><a href="#1-jwt-bearer-token" class="level-3">1. JWT Bearer Token</a></li>
<li><a href="#poluchenie-tokena" class="level-1">Получение токена</a></li>
<li><a href="#response" class="level-1">Response:</a></li>
<li><a href="#ispolzovanie-tokena" class="level-1">Использование токена</a></li>
<li><a href="#logout-dobavlenie-tokena-v-blacklist" class="level-1">Logout - добавление токена в blacklist</a></li>
<li><a href="#2-api-klyuchi" class="level-3">2. API-ключи</a></li>
<li><a href="#sozdanie-api-klyucha" class="level-1">Создание API-ключа</a></li>
<li><a href="#response" class="level-1">Response:</a></li>
<li><a href="#ispolzovanie-api-klyucha" class="level-1">Использование API-ключа</a></li>
<li><a href="#3-oauth2oidc-gotovo-k-integratsii" class="level-3">3. OAuth2/OIDC (готово к интеграции)</a></li>
<li><a href="#4-ldapactive-directory-gotovo-k-integratsii" class="level-3">4. LDAP/Active Directory (готово к интеграции)</a></li>
<li><a href="#api-reference" class="level-2">API Reference</a></li>
<li><a href="#middleware-zavisimosti" class="level-3">Middleware зависимости</a></li>
<li><a href="#primery-ispolzovaniya-v-fastapi" class="level-3">Примеры использования в FastAPI</a></li>
<li><a href="#trebovat-konkretnoe-razreshenie" class="level-1">Требовать конкретное разрешение</a></li>
<li><a href="#trebovat-odno-iz-neskolkih-razresheniy" class="level-1">Требовать одно из нескольких разрешений</a></li>
<li><a href="#trebovat-rol-admin" class="level-1">Требовать роль Admin</a></li>
<li><a href="#authcontext" class="level-3">AuthContext</a></li>
<li><a href="#audit-i-logirovanie" class="level-2">Аудит и логирование</a></li>
<li><a href="#sobytiya-avtorizatsii" class="level-3">События авторизации</a></li>
<li><a href="#format-loga" class="level-3">Формат лога</a></li>
<li><a href="#luchshie-praktiki" class="level-2">Лучшие практики</a></li>
<li><a href="#dlya-administratorov" class="level-3">Для администраторов</a></li>
<li><a href="#dlya-razrabotchikov" class="level-3">Для разработчиков</a></li>
<li><a href="#svyazannye-dokumenty" class="level-2">Связанные документы</a></li>
      </ul>
    </aside>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-brand">
          <img src="../../../assets/svg/logo.svg" alt="CodeGraph" width="160" height="40">
          <p>AI-копилот для анализа исходного кода</p>
        </div>
        <div class="footer-links">
          <div class="footer-links-group">
            <h4>Продукт</h4>
            <ul class="footer-links-list">
              <li><a href="../../../index.html#features" class="footer-link">Возможности</a></li>
              <li><a href="../../../index.html#integrations" class="footer-link">Интеграции</a></li>
              <li><a href="../../../index.html#faq" class="footer-link">FAQ</a></li>
            </ul>
          </div>
          <div class="footer-links-group">
            <h4>Документация</h4>
            <ul class="footer-links-list">
              <li><a href="../getting-started/index.html" class="footer-link">Начало работы</a></li>
              <li><a href="../guides/index.html" class="footer-link">Руководства</a></li>
              <li><a href="../api/index.html" class="footer-link">API</a></li>
              <li><a href="../enterprise/index.html" class="footer-link">Enterprise</a></li>
            </ul>
          </div>
          <div class="footer-links-group">
            <h4>Ресурсы</h4>
            <ul class="footer-links-list">
              <li><a href="../../../whitepaper.html" class="footer-link">Whitepaper</a></li>
            </ul>
          </div>
          <div class="footer-links-group">
            <h4>Контакты</h4>
            <ul class="footer-links-list">
              <li><a href="mailto:hello@codegraph.ru" class="footer-link">hello@codegraph.ru</a></li>
              <li><a href="https://t.me/codegraph" class="footer-link" target="_blank" rel="noopener">Telegram</a></li>
              <li><a href="https://github.com/codegraph" class="footer-link" target="_blank" rel="noopener">GitHub</a></li>
            </ul>
            <div class="footer-social">
              <a href="https://t.me/codegraph" class="footer-social-link" target="_blank" rel="noopener" aria-label="Telegram">
                <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                  <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                </svg>
              </a>
              <a href="https://github.com/codegraph" class="footer-social-link" target="_blank" rel="noopener" aria-label="GitHub">
                <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                  <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
              </a>
            </div>
          </div>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2025 CodeGraph. Все права защищены.</p>
      </div>
    </div>
  </footer>

  <script src="../../../js/main.js"></script>
</body>
</html>
